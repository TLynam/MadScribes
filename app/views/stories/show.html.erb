<div class="page-header">
  <h1><%= @story.title %> <small>by <%= @story.user.email %></small></h1>
</div>

<% if !@story.started_at && @story.user == current_user %>
  <h3><%= button_to "Ready Player One?", start_story_path, class: "btn btn-success" %></h3>
<% end %>

<p><%= @story.create_body %></p>
<% unless @story.active? %>
  <div class="sentence_container">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Round</th>
            <th>Author</th>
            <th>Votes</th>
            <th>Sentence</th>
          </tr>
        </thead>
        <tbody>
          <% @story.sentences.where(winner: true).order(:round).each do |sentence| %>
            <tr>
              <td><%= sentence.round %></td>
              <td><%= sentence.user.email %></td>
              <td><%= sentence.votes.count %></td>
              <td><%= sentence.body %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<h3><div id="startCountdown"><%= 'Current Round: ' + @story.round.to_s if @story.active? %></div></h3>

<% if @story.active? %>
  <div class="progress">
    <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: <%= @story.percent_story_left %>%;">
      <% if @story.percent_story_left > 15 && @story.percent_story_left < 100 %>
        Story Completed <%= @story.percent_story_left %>%
      <% elsif @story.percent_story_left == 100 %>
        Last Round    
      <% end %>
    </div>
  </div>
<% end %>

<% if @story.active? %>
  <h3>Period Time:<div id="countdown"><%= @story.seconds_left_in_period %></div></h3>
<% else %>
  <div id="countdown" style="display:none;">-1</div>
<% end %>

<% if @story.period == :writing %>
  <%= form_for @sentence, url: story_sentences_url(@story), html: {class: "form-horizontal"} do |f| %>
    <h3>Submit a Sentence</h3>
    <div class="field form-group">
      <%= f.label :body, class: "col-sm-1 control-label" %>
      <div class="col-sm-11">
        <%= f.text_field :body, class: "form-control", :autofocus => true, disabled: @story.sentence_submitted?(current_user) %>
      </div>
    </div>
    <div class="actions form-group">
      <div class="col-sm-offset-1 col-sm-11">
        <% button_text = @story.sentence_submitted?(current_user) ? "Can only submit one sentence per round" : "Submit" %>
        <%= f.submit button_text, class: "btn btn-success", disabled: @story.sentence_submitted?(current_user) %>
      </div>
    </div>
  <% end %>
<% end %>

<% if @story.period == :voting %>
  <h3>Vote now</h3>
  <div class="sentence_container">
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Round</th>
            <th>Sentence</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% @story.sentences.where(round: @story.round).order(created_at: :desc).each do |sentence| %>
            <tr>
              <td><%= sentence.round %></td>
              <td><%= sentence.body %></td>
              <% button_text = @story.vote_submitted?(current_user) ? "Can only vote once per round" : "Vote" %>
              <td><%= button_to button_text, vote_story_sentence_path(@story,sentence), method: :post, disabled: @story.vote_submitted?(current_user), class: "btn btn-primary" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<% if @story.started_at && !@story.round %>
  <h3>Game Over</h3>
<% end %>

<script type="text/javascript">
  var seconds;
  var temp;
  function countdown() {
    seconds = document.getElementById('countdown').innerHTML;
    seconds = parseInt(seconds, 10);
 
    if (seconds == 0) {
      temp = document.getElementById('countdown');
      window.location.reload();
      return;
    } else if (seconds < 0 && seconds % 4 == 0) {
      $.getJSON("<%= story_url %>", { id: <%= @story.id %> } ).success(function(data){
        if( data == true){
          window.location.reload();
          return;
        }
      });
    }
 
    seconds--;
    temp = document.getElementById('countdown');
    temp.innerHTML = seconds;
    timeoutMyOswego = setTimeout(countdown, 1000);
  } 
  countdown();
</script>